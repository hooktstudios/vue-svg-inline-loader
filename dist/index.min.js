"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var path=require("path");var crypto=require("crypto");var _require=require("fs"),readFileSync=_require.readFileSync;var _require2=require("loader-utils"),getOptions=_require2.getOptions;var validateOptions=require("schema-utils");var SVGO=require("svgo");var DEFAULT_OPTIONS=freeze({inline:{keyword:"svg-inline",strict:true},sprite:{keyword:"svg-sprite",strict:true},dataAttributes:[],removeAttributes:["alt","src"],md5:true,xhtml:false,svgo:{plugins:[{removeViewBox:false}]}});var DEFAULT_OPTIONS_SCHEMA=freeze({type:"object",properties:{inline:{type:"object",properties:{keyword:{type:"string"},strict:{type:"boolean"}},additionalProperties:false},sprite:{type:"object",properties:{keyword:{type:"string"},strict:{type:"boolean"}},additionalProperties:false},dataAttributes:{type:"array"},removeAttributes:{type:"array"},md5:{type:"boolean"},xhtml:{type:"boolean"},svgo:{oneOf:[{type:"object",properties:{plugins:{type:"array"}},additionalProperties:false},{type:"boolean"},{enum:[null]}]}},additionalProperties:false});var PATTERN_VUE_SFC_HTML=/^\s*<template(?:\s+[^>]*lang[\s="']+html["'][^>]*)?>\s*/i;var PATTERN_BEFORE_ROOT_CLOSE_TAG=/(<template[^>]*>[\s\S]+)(\s*<\/[^>]+>[\s\S]*<\/template>)/i;var PATTERN_IMAGE_SRC_SVG=/<img\s+[^>]*src[\s="']+([^"']+\.svg)(?:[?#][^"']*)?["'][^>]*\/?>/gi;var PATTERN_SVG_CONTENT=/<svg(\s+[^>]+)?>([\s\S]+)<\/svg>/i;var PATTERN_SVG_OPEN_TAG=/^<svg/i;var PATTERN_ATTRIBUTES=/\s*([:@]?[^\s=]+)[\s=]+(?:"([^"]*)"|'([^']*)')?\s*/g;var PATTERN_ATTRIBUTE_NAME=/^[:@]?[a-z][a-z-]+[a-z]$/i;var PATTERN_TAG=/^<|>$/;var PATTERN_DEPRECATED_OPTION=/^(inline|sprite)(keyword|strict)$/i;module.exports=function(content){var _this=this;this.cacheable&&this.cacheable();var callback=this.async();var loaderOptions=getOptions(this)||{};var loaderOptionsPropNames=Object.getOwnPropertyNames(loaderOptions);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=loaderOptionsPropNames[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var name=_step.value;if(PATTERN_DEPRECATED_OPTION.test(name)){var value=loaderOptions[name];var matches=name.toLowerCase().match(PATTERN_DEPRECATED_OPTION);merge(loaderOptions,{arrayConcat:false,arrayUnique:false,overwrite:false,skipUndefined:true},(0,_defineProperty2["default"])({},matches[1],(0,_defineProperty2["default"])({},matches[2],value)));delete loaderOptions[name]}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator["return"]!=null){_iterator["return"]()}}finally{if(_didIteratorError){throw _iteratorError}}}var options=merge({},{arrayConcat:false,arrayUnique:false,overwrite:true,skipUndefined:true},DEFAULT_OPTIONS,loaderOptions);["dataAttributes","removeAttributes"].forEach(function(option){options[option]=options[option].map(function(attribute){return attribute.toLowerCase()});options[option].forEach(function(attribute){[":","@"].forEach(function(shorthand){options[option].push(shorthand+attribute)})})});validateOptions(DEFAULT_OPTIONS_SCHEMA,options,"vue-svg-inline-loader");options._svgo=!!options.svgo;options._sprites=!!(path.extname(this.resourcePath).toLowerCase()===".vue"&&PATTERN_VUE_SFC_HTML.test(content));for(var _i=0,_arr=[options.inline.keyword,options.sprite.keyword];_i<_arr.length;_i++){var keyword=_arr[_i];if(!PATTERN_ATTRIBUTE_NAME.test(keyword)){throw new Error("Keyword ".concat(keyword," is not valid."))}}var PATTERN_INLINE_KEYWORD=new RegExp("\\s+(?:data-)?".concat(options.inline.keyword,"\\s+"),"i");var PATTERN_SPRITE_KEYWORD=new RegExp("\\s+(?:data-)?".concat(options.sprite.keyword,"\\s+"),"i");var svgo=options._svgo&&new SVGO(options.svgo===true?DEFAULT_OPTIONS.svgo:options.svgo);var symbols=new Set;replace(content,PATTERN_IMAGE_SRC_SVG,function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(image,source){var filePath,file,attributes,attribute,name,value,_iteratorNormalCompletion2,_didIteratorError2,_iteratorError2,_iterator2,_step2,_attribute,_iteratorNormalCompletion3,_didIteratorError3,_iteratorError3,_iterator3,_step3,_attribute2;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(options.inline.strict&&!PATTERN_INLINE_KEYWORD.test(image))){_context.next=2;break}return _context.abrupt("return",image);case 2:_context.next=4;return new Promise(function(resolve,reject){_this.resolve(_this.context,source,function(error,resolvedPath){if(error){reject(error)}resolve(resolvedPath)})});case 4:filePath=_context.sent;file={path:filePath};_this.addDependency(path.normalize(file.path));_context.prev=7;file.content=readFileSync(file.path,{encoding:"utf-8"});_context.next=14;break;case 11:_context.prev=11;_context.t0=_context["catch"](7);throw new Error("File ".concat(file.path," does not exist."));case 14:if(PATTERN_SVG_CONTENT.test(file.content)){_context.next=16;break}throw new Error("File ".concat(file.path," is empty."));case 16:_context.prev=16;_context.t2=options._svgo;if(!_context.t2){_context.next=22;break}_context.next=21;return svgo.optimize(file.content,{path:file.path});case 21:_context.t2=_context.sent.data;case 22:_context.t1=_context.t2;if(_context.t1){_context.next=25;break}_context.t1=file.content;case 25:file.content=_context.t1;_context.next=31;break;case 28:_context.prev=28;_context.t3=_context["catch"](16);throw new Error("SVGO for ".concat(file.path," failed."));case 31:if(options._sprites&&(!options.sprite.strict||PATTERN_SPRITE_KEYWORD.test(image))){file.content=file.content.replace(PATTERN_SVG_CONTENT,function(svg,attributes,symbol){var developmentId=[_this.resourcePath,file.path].map(function(path){return path.replace(_this.rootContext,"")}).join(":");var id=[options.sprite.keyword,options.md5?crypto.createHash("md5").update(developmentId).digest("hex"):developmentId].join(options.md5?"-":":");symbols.add('<symbol id="'.concat(id,'"').concat(attributes,">").concat(symbol,"</symbol>"));return'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><use xlink:href="#'.concat(id,'" href="#').concat(id,'"></use></svg>')})}attributes=new Map;PATTERN_ATTRIBUTES.lastIndex=0;while(attribute=PATTERN_ATTRIBUTES.exec(image)){if(attribute.index===PATTERN_ATTRIBUTES.lastIndex){PATTERN_ATTRIBUTES.lastIndex++}if(attribute[1]&&!PATTERN_TAG.test(attribute[1])&&PATTERN_ATTRIBUTE_NAME.test(attribute[1])){name=attribute[1];value=attribute[2]||attribute[3];attributes.set(name.toLowerCase(),value?value:(options.xhtml?name:"").toLowerCase())}}if(!attributes.has("focusable")){attributes.set("focusable","false")}if(!attributes.has("role")){attributes.set("role","presentation")}_iteratorNormalCompletion2=true;_didIteratorError2=false;_iteratorError2=undefined;_context.prev=40;for(_iterator2=options.dataAttributes[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){_attribute=_step2.value;if(attributes.has(_attribute)){attributes.set("data-".concat(_attribute),attributes.get(_attribute));attributes["delete"](_attribute)}}_context.next=48;break;case 44:_context.prev=44;_context.t4=_context["catch"](40);_didIteratorError2=true;_iteratorError2=_context.t4;case 48:_context.prev=48;_context.prev=49;if(!_iteratorNormalCompletion2&&_iterator2["return"]!=null){_iterator2["return"]()}case 51:_context.prev=51;if(!_didIteratorError2){_context.next=54;break}throw _iteratorError2;case 54:return _context.finish(51);case 55:return _context.finish(48);case 56:_iteratorNormalCompletion3=true;_didIteratorError3=false;_iteratorError3=undefined;_context.prev=59;for(_iterator3=options.removeAttributes[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){_attribute2=_step3.value;attributes["delete"](_attribute2)}_context.next=67;break;case 63:_context.prev=63;_context.t5=_context["catch"](59);_didIteratorError3=true;_iteratorError3=_context.t5;case 67:_context.prev=67;_context.prev=68;if(!_iteratorNormalCompletion3&&_iterator3["return"]!=null){_iterator3["return"]()}case 70:_context.prev=70;if(!_didIteratorError3){_context.next=73;break}throw _iteratorError3;case 73:return _context.finish(70);case 74:return _context.finish(67);case 75:return _context.abrupt("return",attributes.size?file.content.replace(PATTERN_SVG_OPEN_TAG,"$& "+(0,_toConsumableArray2["default"])(attributes.keys()).map(function(attribute){return"".concat(attribute,'="').concat(attributes.get(attribute),'"')}).join(" ")):file.content);case 76:case"end":return _context.stop()}}},_callee,null,[[7,11],[16,28],[40,44,48,56],[49,,51,55],[59,63,67,75],[68,,70,74]])}));return function(_x,_x2){return _ref.apply(this,arguments)}}()).then(function(content){return callback(null,options._sprites&&symbols.size?content.replace(PATTERN_BEFORE_ROOT_CLOSE_TAG,'$1<svg xmlns="http://www.w3.org/2000/svg" style="display: none !important;">'.concat((0,_toConsumableArray2["default"])(symbols).join(""),"</svg>$2")):content)})["catch"](function(error){return callback(error)})};function replace(_x3,_x4,_x5){return _replace.apply(this,arguments)}function _replace(){_replace=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(string,regex,callback){var promises,data;return _regenerator["default"].wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:regex.lastIndex=0;promises=[];string.replace(regex,function(match){for(var _len2=arguments.length,args=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2]}var promise=callback.apply(void 0,[match].concat(args));promises.push(promise)});_context2.next=5;return Promise.all(promises);case 5:data=_context2.sent;return _context2.abrupt("return",data.length?string.replace(regex,function(){return data.shift()}):string);case 7:case"end":return _context2.stop()}}},_callee2)}));return _replace.apply(this,arguments)}function freeze(object){var propNames=Object.getOwnPropertyNames(object);var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=propNames[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var name=_step4.value;var value=object[name];object[name]=value&&(0,_typeof2["default"])(value)==="object"?freeze(value):value}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4["return"]!=null){_iterator4["return"]()}}finally{if(_didIteratorError4){throw _iteratorError4}}}return Object.freeze(object)}function merge(object,options){for(var _len=arguments.length,sources=new Array(_len>2?_len-2:0),_key=2;_key<_len;_key++){sources[_key-2]=arguments[_key]}for(var _i2=0,_sources=sources;_i2<_sources.length;_i2++){var source=_sources[_i2];var propNames=Object.getOwnPropertyNames(source);var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=propNames[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var name=_step5.value;var value=source[name];if(options&&options.skipUndefined&&value===undefined){continue}if(value===object[name]){continue}if(value&&(0,_typeof2["default"])(value)==="object"){if(options&&options.arrayConcat&&Array.isArray(object[name])&&Array.isArray(value)){object[name]=object[name].concat(value);if(options&&options.arrayUnique){object[name]=Array.from(new Set(object[name]))}}else if(Array.isArray(value)){object[name]=options&&options.overwrite||object[name]===undefined?value:object[name]}else{object[name]=merge(object[name]||{},options,value)}}else{object[name]=options&&options.overwrite||object[name]===undefined?value:object[name]}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5["return"]!=null){_iterator5["return"]()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}return object}